window.onload=function(){var list=[];var namespace='/message';var socket=io.connect(location.protocol+'//'+document.domain+':'+location.port+namespace);function guid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16)})}function goToBottom(){document.getElementById('out').scrollTop=document.getElementById('out').scrollHeight}function setCookie(name,value){var Days=30;var exp=new Date();exp.setTime(exp.getTime()+Days*24*60*60*1000);document.cookie=name+"="+escape(value)+";expires="+exp.toGMTString()}function getCookie(name){var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");if(arr=document.cookie.match(reg))return unescape(arr[2]);else return null}function delCookie(name){var exp=new Date();exp.setTime(exp.getTime()-1);var cval=getCookie(name);if(cval!=null)document.cookie=name+"="+cval+";expires="+exp.toGMTString()}function stringToArrayAscii(string){var message=[];for(var i=0;i<string.length;i++){message[message.length]=string[i].charCodeAt()}return message}function arrayAsciiToString(array){var message="";for(var i=0;i<array.length;i++){message+=String.fromCharCode(array[i])}return message}function sendStatus(status){var type;if(status===true)type='online';else type='unlike';socket.emit('message',{message:stringToArrayAscii(getCookie('name')),type:type})}if(getCookie('name')==null||getCookie('name')==='null'){var name=prompt("请输入姓名:");while(name===''||name==='null')name=prompt("请输入姓名:");if(name==null)window.close();setCookie("name",name)}if(getCookie('guid')==null)setCookie("guid",guid());if(getCookie('online')==null){setCookie('online',1);sendStatus(true)}if(localStorage.getItem('list'))list=JSON.parse(localStorage.getItem('list'));window.onbeforeunload=function(){delCookie('online');sendStatus(false)};var app=new Vue({el:'#App',data:{message:'',name:getCookie('name'),list:list},created:function(){document.getElementById('out').style.display='block'},updated:function(){goToBottom()},methods:{sendMessage:function(){if(this.message==='')return'';socket.emit('message',{message:stringToArrayAscii(this.message),name:stringToArrayAscii(this.name),cookie:document.cookie,type:"text"});this.message=''},sendImage:function(event){var files=event.target.files;if(files[0].type!=='image/jpeg'&&files[0].type!=='image/png'&&files[0].type!=='image/gif'){alert("图片格式错误 请使用jpg,png,gif");return false}var file=files[0];var reader=new FileReader();var name=stringToArrayAscii(this.name);reader.onload=function(){var result=this.result;socket.emit('message',{message:result,name:name,cookie:document.cookie,type:"image"})};reader.readAsDataURL(file)}}});socket.on('my_response',function(msg){if(msg.cookie===document.cookie){msg.style="message-re message-my message-my-before"}else if(msg.type==='online'||msg.type==='unlike'){msg.style="message-re notice";msg.message=arrayAsciiToString(msg.message)}if(msg.type==='text')msg.message=arrayAsciiToString(msg.message);if(msg.name)msg.name=arrayAsciiToString(msg.name);app.list.push(msg);localStorage.setItem("list",JSON.stringify(app.list))})};